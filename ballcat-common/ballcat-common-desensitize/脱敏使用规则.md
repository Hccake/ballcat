# 脱敏使用规则

## 一、引入`ballcat-common-desensitize`坐标

```xml
  <dependency>
            <groupId>com.hccake</groupId>
            <artifactId>ballcat-common-desensitize</artifactId>
            <version>${version}</version>
  </dependency>
```

## 二、将`JsonSerializerModifier`引入到当前工程的ObjectMapper对象中

```java
//1.创建Object对象
ObjectMapper objectMapper = new ObjectMapper();
//2.实例化JsonSerializerModifier
JsonSerializerModifier modifier = new JsonSerializerModifier();
//3.将自定义序列化构建器 注册进ObjectMapper
objectMapper.setSerializerFactory(objectMapper.getSerializerFactory().withSerializerModifier(modifier));
```

## 三、新建实体类`DesensitizationUser`

```java
/**
 * @author Hccake 2021/1/23
 * @version 1.0
 */
@Data
@Accessors(chain = true)
public class DesensitizationUser {

	/**
	 * 用户名，不脱敏
	 */
	private String username;

	/**
	 * 密码脱敏
	 */
	@JsonRegexDesensitize(type = RegexDesensitizationTypeEnum.ENCRYPTED_PASSWORD)
	private String password;

	/**
	 * 邮件
	 */
	@JsonRegexDesensitize(type = RegexDesensitizationTypeEnum.EMAIL)
	private String email;

	/**
	 * 手机号
	 */
	@JsonSlideDesensitize(type = SlideDesensitizationTypeEnum.PHONE_NUMBER)
	private String phoneNumber;

	/**
	 * 测试自定义脱敏
	 */
	@JsonSimpleDesensitize(handler = TestDesensitizationHandler.class)
	private String testField;

}

```

## 四、执行序列化方法

```java
	DesensitizationUser user = new DesensitizationUser()
        .setEmail("chengbohua@foxmail.com")
        .setUsername("xiaoming")
		.setPassword("admina123456")
        .setPhoneNumber("15800000000")
        .setTestField("这是测试属性");
	String value = objectMapper.writeValueAsString(user);
    Assert.isTrue("{\"username\":\"xiaoming\",\"password\":\"adm****56\",\"email\":\"c****@foxmail.com\",\"phoneNumber\":\"158******00\",\"testField\":\"TEST-这是测试属性\"}"
						.equals(value));
```

## 附: 扩展方法

### 一、根据字段属性自定义是否进行脱敏

> 只需要修改`JsonSerializerModifier`实列方式,增加`DesensitizeHandler`实现类即可

```java
       //指定DesensitizeHandler 若ignore方法为true 则忽略脱敏 false 则启用脱敏
		JsonSerializerModifier modifier = new JsonSerializerModifier((fieldName) -> {
			log.info("当前字段名称{}",fieldName);
			return false;
		});
```



### 二、自定义注解与注解处理器

#### 一、新增自定义注解

```java
@Target({ ElementType.FIELD })
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface CustomerDesensitize {

	/**
	 * 类型字段
	 * @return type
	 */
	String type();

}

```

#### 二、注册自定义脱敏类型处理器

```java
//实现自定义脱敏处理器
DesensitizationHandler desensitizationHandlerExtend=new DesensitizationHandlerExtendHandler();
//将自定义脱敏处理器绑定
DesensitizationHandlerHolder.addHandler(DesensitizationHandlerExtendHandler.class,desensitizationHandlerExtend);
```

#### 三、注册注解处理器

> 若要高度扩展 可直接注册注解处理函数，省略第二步骤的自定义脱敏类型处理器

```java
AnnotationHandlerHolder.addHandleFunction(CustomerDesensitize.class, ((annotation, value) -> {
			CustomerDesensitize an = (CustomerDesensitize) annotation;
			String typeValue = an.type();
			DesensitizationHandlerExtendHandler desensitizationHandler = DesensitizationHandlerHolder
					.getHandler(DesensitizationHandlerExtendHandler.class);
			Assert.notNull(desensitizationHandler, "SimpleDesensitizationHandler can not be Null");
			return desensitizationHandler.handle(value);
		}));
```

#### 四、在实体字段上指定自定义注解

```java
	@CustomerDesensitize(type = "test-data")
	private String customDesensitize;
```



#### 三、单元测试

```java
@Test
	void desensitizedExtend() throws JsonProcessingException {
		// 指定DesensitizeHandler 若ignore方法为true 则忽略脱敏 false 则启用脱敏
		JsonSerializerModifier modifier = new JsonSerializerModifier((fieldName) -> {
			log.info("当前字段名称{}", fieldName);
			return false;
		});
		objectMapper.setSerializerFactory(objectMapper.getSerializerFactory().withSerializerModifier(modifier));
		// 注册我们自定义的脱敏处理 
	AnnotationHandlerHolder.addHandleFunction(CustomerDesensitize.class, ((annotation, value) -> {
			CustomerDesensitize an = (CustomerDesensitize) annotation;
			Class<? extends SimpleDesensitizationHandler> handlerClass = an.handler();
			SimpleDesensitizationHandler desensitizationHandler = DesensitizationHandlerHolder
					.getSimpleHandler(handlerClass);
			Assert.notNull(desensitizationHandler, "SimpleDesensitizationHandler can not be Null");
			return desensitizationHandler.handle(value);
		}));

        
		DesensitizationUser user = new DesensitizationUser()
            
            .setEmail("chengbohua@foxmail.com")
            .setUsername("xiaoming")
		    .setPassword("admina123456")
            .setPhoneNumber("15800000000")
            .setTestField("这是测试属性")
			.setCustomDesensitize("自定义属性");
		String value = objectMapper.writeValueAsString(user);

		log.info("脱敏后的数据：{}", value);
	}
```

### 三、在Springboot配置脱敏

```java
	/**
	 * 注册 Jackson 的序列化器，用于处理 desensitized 类型参数
	 * @return Jackson2ObjectMapperBuilderCustomizer
	 */
	@Bean
	public Jackson2ObjectMapperBuilderCustomizer desensitizeJacksonCustomizer() {
		SimpleModule simpleModule = new SimpleModule();
        simpleModule.setSerializerModifier(new JsonSerializerModifier(fieldName -> {
            //进行字段级别控制 是否需要脱敏 true 忽略 false 脱敏
            return true;
        }));
		return builder -> builder.modules(simpleModule);
	}
```

